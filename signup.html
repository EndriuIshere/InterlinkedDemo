<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interlinked — Registrati</title>
  <style>
    :root { --gap:12px; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      min-height:100vh; background:#0f172a; color:#e5e7eb;
      display:grid; place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding:16px;
    }
    .card {
      width:100%; max-width:420px;
      background:#0b1220; border:1px solid #334155; border-radius:16px;
      padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; gap:14px;
    }
    .title { font-weight:900; font-size:1.6rem; text-align:center; margin-bottom:6px; }
    .field { display:flex; flex-direction:column; gap:6px; position:relative; }
    label { font-size:.9rem; color:#cbd5e1; }
    input {
      width:100%; padding:12px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; height:44px;
    }
    .with-eye { padding-right:44px; }

    .icon-btn {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:40px; height:40px; display:grid; place-items:center;
      background:transparent; border:0; border-radius:8px; cursor:pointer; color:#94a3b8;
    }
    .icon-btn:hover { color:#cbd5e1; background:#0f1b33; }
    .icon-btn:active { transform:translateY(-50%) scale(0.98); }
    .icon-btn svg { width:22px; height:22px; aspect-ratio:1 / 1; display:block; }

    .btn {
      width:100%; padding:12px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer;
      font-weight:700;
    }
    .btn:hover { background:#10192c; }
    .muted { text-align:center; font-size:.9rem; color:#94a3b8; }
    .link { color:#93c5fd; cursor:pointer; }
    .error { color:#fca5a5; font-size:.9rem; min-height:1.2em; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Crea Account</div>

    <div class="field">
      <label for="email">E-mail</label>
      <input id="email" type="email" autocomplete="email" />
    </div>

    <div class="field">
      <label for="password">Password</label>
      <input id="password" class="with-eye" type="password" autocomplete="new-password" />
      <button id="toggleEye" class="icon-btn" type="button" aria-label="Mostra password" aria-pressed="false" title="Mostra password">
        <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
          <line id="eyeSlash" x1="3" y1="3" x2="21" y2="21" style="display:none"></line>
        </svg>
      </button>
    </div>

    <div class="field">
      <label for="username">Username</label>
      <input id="username" type="text" placeholder="Scegli un nome utente" />
    </div>

    <div class="field">
      <label for="phone">Telefono (opzionale)</label>
      <input id="phone" type="tel" placeholder="Es. +393331234567" autocomplete="tel" />
    </div>

    <button id="signupBtn" class="btn">Registrati</button>
    <div class="muted">Hai già un account? <a href="login.html" class="link">Accedi</a></div>
    <div id="error" class="error"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyAd2Uv9xA36L49YPezEO1QpC6P7t9zHXto",
      authDomain: "interlinked-demo.firebaseapp.com",
      databaseURL: "https://interlinked-demo-default-rtdb.firebaseio.com",
      projectId: "interlinked-demo",
      storageBucket: "interlinked-demo.firebasestorage.app",
      messagingSenderId: "85117709871",
      appId: "1:85117709871:web:a154569112f845e2bfe0da",
      measurementId: "G-RBLX6ZQD01"
    });
    const auth = firebase.auth();
    const db = firebase.database();
    auth.onAuthStateChanged(u => { if (u) location.replace('index.html'); });

    const $ = s => document.querySelector(s);
    const showErr = (m)=> $("#error").textContent = m || "";

    // Toggle password + accessibilità
    (function(){
      const btn = document.getElementById("toggleEye");
      const slash = document.getElementById("eyeSlash");
      const input = document.getElementById("password");
      const setVisible = (visible) => {
        input.type = visible ? "text" : "password";
        slash.style.display = visible ? "block" : "none";
        btn.setAttribute("aria-pressed", visible ? "true" : "false");
        btn.setAttribute("title", visible ? "Nascondi password" : "Mostra password");
      };
      const toggle = () => setVisible(input.type === "password");
      btn.addEventListener("click", toggle);
      btn.addEventListener("keydown", (e)=> {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
      });
      // Hold to peek
      const pressStart = () => setVisible(true);
      const pressEnd = () => setVisible(false);
      btn.addEventListener("mousedown", pressStart);
      btn.addEventListener("mouseup", pressEnd);
      btn.addEventListener("mouseleave", pressEnd);
      btn.addEventListener("touchstart", pressStart, { passive:true });
      btn.addEventListener("touchend", pressEnd);
      btn.addEventListener("touchcancel", pressEnd);
    })();

    // Registrazione
    document.getElementById("signupBtn").addEventListener("click", async ()=>{
      showErr("");
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("password").value;
      const uname = document.getElementById("username").value.trim();
      const phoneRaw = document.getElementById("phone").value.trim();
      const phone = normalizePhone(phoneRaw);
      if(!email || !pass || !uname) return showErr("Completa tutti i campi.");
      try{
        // se presente, verifica univocità telefono tramite indice /byPhone/<num>
        if (phone) {
          const phoneSnap = await db.ref("byPhone/"+phone).once("value");
          if (phoneSnap.exists()) { return showErr("Numero di telefono già registrato."); }
        }

        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = cred.user.uid;
        await db.ref("users/"+uid+"/profile").set({ email, phone: phone || null, name: uname });
        // indici rapidi per lookup
        const updates = {};
        updates["byEmail/"+email.toLowerCase()] = uid;
        if (phone) updates["byPhone/"+phone] = uid;
        await db.ref().update(updates);
        location.replace('index.html');
      }catch(e){ showErr(mapErr(e)); }
    });

    // Normalizza numeri: rimuove spazi/separatori, mantiene + e cifre, toUpper non necessario
    function normalizePhone(input){
      if (!input) return "";
      const trimmed = input.replace(/\s+/g, "");
      // Consenti + all'inizio, poi cifre
      const m = trimmed.match(/^\+?[0-9]{6,}$/);
      if (!m) return ""; // se non valido, non salviamo
      // Rimuovi zeri iniziali non significativi se presente +?
      // Manteniamo il '+' se fornito per distinguere internazionale
      if (trimmed.startsWith('+')) return trimmed;
      return trimmed; // altrimenti ritorna solo cifre
    }

    function mapErr(e){
      const c = e?.code || "";
      if (c.includes("auth/invalid-email")) return "E-mail non valida.";
      if (c.includes("auth/weak-password")) return "Password troppo debole (min 6).";
      if (c.includes("auth/email-already-in-use")) return "E-mail già registrata.";
      // return "Errore: " + (e?.message || e);
      return "Errore, riprova!";
    }
  </script>
</body>
</html>
