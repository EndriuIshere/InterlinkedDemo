<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interlinked — Stanza</title>
  <style>
    :root { --gap:12px; }
    * { box-sizing: border-box; }
    html,body { margin:0; height:100%; background:#0f172a; color:#e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; overflow:hidden; }
    .app { height:100%; display:flex; flex-direction:column; padding:var(--gap); gap:var(--gap); }
    .topbar { display:grid; grid-template-columns:40px 1fr 40px; align-items:center;
      gap:8px; padding:8px 6px; border:1px solid #334155; border-radius:12px; background:#0b1220; flex-shrink:0; }
    .iconbtn { display:inline-grid; place-items:center; width:36px; height:36px;
      border-radius:10px; border:1px solid #334155; background:#0b1220; cursor:pointer; color:white; font-size:18px; }
    .iconbtn:hover { background:#10192c; }
    .username { text-align:center; font-weight:700; }
    .kebab { font-size:22px; line-height:0; color:white; }
    .menu { position:relative; justify-self:end; }
    .menu .panel { position:absolute; right:0; top:44px; min-width:200px; padding:10px; border:1px solid #334155;
      background:#0b1220; border-radius:12px; display:none; z-index:10; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .menu.open .panel { display:block; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:14px; }
    input[type="color"] { inline-size:46px; block-size:32px; padding:0; border:none; background:transparent; }
    .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; flex-shrink:0; }
    .pill { padding:6px 10px; border:1px solid #334155; border-radius:999px; background:#0b1220; display:inline-flex; gap:6px; align-items:center; }
    .ok { color:#34d399; } .warn { color:#fbbf24; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .btn { padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer; }
    .btn:hover { background:#10192c; }
    .stage { position:relative; flex:1; border:1px solid #334155; border-radius:12px; overflow:hidden; background:#0b1220; }
    canvas { position:absolute; inset:0; width:100%; height:100%; image-rendering: pixelated; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <button class="iconbtn" id="back" title="Indietro" aria-label="Indietro">⟵</button>
      <div class="username" id="user">stanza</div>
      <div class="menu" id="menu">
        <button class="iconbtn kebab" aria-haspopup="true" aria-expanded="false" title="Menu rapido">⋮</button>
        <div class="panel" role="menu">
          <div class="row"><span>Cambia colore</span><input type="color" id="color" value="#00ffaa"></div>
          <div class="row" style="margin-top:8px"><label>Spaziatura puntini
            <input type="range" id="spacing" min="10" max="40" step="2" value="18"></label></div>
          <div class="row" style="margin-top:8px"><label>Raggio effetto
            <input type="range" id="radius" min="20" max="200" step="4" value="90"></label></div>
          <div class="row" style="margin-top:8px"><label>Durata scia (ms)
            <input type="range" id="life" min="400" max="4000" step="100" value="2000"></label></div>
        </div>
      </div>
    </div>

    <!-- Seconda riga -->
    <div class="controls">
      <span class="pill">Stanza: <code class="mono" id="roomLbl"></code>
        <button class="btn" id="copyRoom">Copia URL</button></span>
      <span class="pill">Connesso: <b id="rtFlag" class="warn">OFF</b></span>
    </div>

    <!-- Canvas -->
    <div class="stage">
      <canvas id="dots"></canvas>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <script>
    // === Config identica ===
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyAd2Uv9xA36L49YPezEO1QpC6P7t9zHXto",
      authDomain: "interlinked-demo.firebaseapp.com",
      databaseURL: "https://interlinked-demo-default-rtdb.firebaseio.com",
      projectId: "interlinked-demo",
      storageBucket: "interlinked-demo.firebasestorage.app",
      messagingSenderId: "85117709871",
      appId: "1:85117709871:web:a154569112f845e2bfe0da",
      measurementId: "G-RBLX6ZQD01"
    };
    firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.database();
    const auth = firebase.auth();

    // Gate: se non loggato torna al login
    auth.onAuthStateChanged(u=>{
      if(!u) location.replace('login.html');
    });

    // Back ai contatti
    document.getElementById("back").addEventListener("click", ()=> location.href='index.html');

    /************ UTIL ************/
    const $ = s => document.querySelector(s);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const rndId = () => Math.random().toString(36).slice(2,10);
    const lerp = (a,b,t)=>a+(b-a)*t;
    function hexToRgb(h){ const x=h.replace('#',''); return { r:parseInt(x.slice(0,2),16), g:parseInt(x.slice(2,4),16), b:parseInt(x.slice(4,6),16) }; }
    function rgbStr({r,g,b,a=1}){ return `rgba(${r|0},${g|0},${b|0},${a})`; }

    /************ STATE ************/
    const canvas = $('#dots');
    const ctx = canvas.getContext('2d',{ alpha:true });
    ctx.imageSmoothingEnabled = false;

    const BG = "#0b1220";
    const BASE_INSIDE = {r:255,g:255,b:255,a:0.85};
    const BASE_OUT    = {r:255,g:0,b:0,a:0.30};

    let zonePath = new Path2D();
    let points = [];        // grid points
    let COLS=0, ROWS=0;     // grid dims per spacing
    let COLOR = '#00ffaa';
    let SPACING = 18;
    let RADIUS  = 90;
    let LIFE_MS = 2000;

    const BASE_R = 2;
    const BOOST  = 3.2;

    const CLIENT = 'c_' + rndId();
    const ROOM = (location.hash && location.hash.slice(1)) || ('room_' + rndId());
    if (!location.hash) history.replaceState(null, '', location.pathname + '#' + ROOM);
    $('#roomLbl').textContent = ROOM;
    $('#user').textContent = 'Stanza ' + ROOM;

    let RT = { enabled:false, db:null };

    /************ GRIGLIA ************/
    function resizeCanvas(){
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      buildZone();
    }
    function buildZone(){
      zonePath = new Path2D();
      const x=0, y=0, w=canvas.width, h=canvas.height, r=20;
      zonePath.moveTo(x+r,y);
      zonePath.arcTo(x+w,y,x+w,y+r,r);
      zonePath.arcTo(x+w,y+h,x+w-r,y+h,r);
      zonePath.arcTo(x,y+h,x,y+h-r,r);
      zonePath.arcTo(x,y,x+r,y,r);

      points = [];
      COLS = Math.floor(w / SPACING) + 1;
      ROWS = Math.floor(h / SPACING) + 1;

      for (let row=0; row<ROWS; row++){
        for (let col=0; col<COLS; col++){
          const px = col*SPACING, py = row*SPACING;
          points.push({ x:px, y:py, inside: ctx.isPointInPath(zonePath, px, py), heat: 0, col: {r:255,g:255,b:255} });
        }
      }
    }
    function applyBrush(cx, cy, colorHex=COLOR, radius=RADIUS){
      const col = hexToRgb(colorHex);
      const minCol = clamp(Math.floor((cx - radius)/SPACING), 0, COLS-1);
      const maxCol = clamp(Math.ceil ((cx + radius)/SPACING), 0, COLS-1);
      const minRow = clamp(Math.floor((cy - radius)/SPACING), 0, ROWS-1);
      const maxRow = clamp(Math.ceil ((cy + radius)/SPACING), 0, ROWS-1);
      for (let row=minRow; row<=maxRow; row++){
        for (let colIdx=minCol; colIdx<=maxCol; colIdx++){
          const i = row*COLS + colIdx;
          const p = points[i]; if (!p) continue;
          const dx = p.x - cx, dy = p.y - cy;
          const d = Math.hypot(dx,dy);
          if (d <= radius){
            const k = 1 - (d / radius);
            const influence = k*k;
            if (influence > p.heat){ p.heat = influence; p.col = col; }
          }
        }
      }
    }

    /************ RENDER ************/
    let lastTime = performance.now();
    function drawFrame(){
      const now = performance.now();
      const dt = now - lastTime; lastTime = now;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save(); ctx.fillStyle = BG; ctx.fill(zonePath); ctx.restore();
      for (let i=0;i<points.length;i++){
        const p = points[i];
        if (p.heat > 0) p.heat = Math.max(0, p.heat - (dt / LIFE_MS));
        const size = 2 + p.heat * (2 * 3.2);
        const base = p.inside ? BASE_INSIDE : BASE_OUT;
        const r = p.inside ? lerp(base.r, p.col.r, p.heat) : (p.heat>0 ? lerp(base.r, p.col.r, p.heat) : base.r);
        const g = p.inside ? lerp(base.g, p.col.g, p.heat) : (p.heat>0 ? lerp(base.g, p.col.g, p.heat) : base.g);
        const b = p.inside ? lerp(base.b, p.col.b, p.heat) : (p.heat>0 ? lerp(base.b, p.col.b, p.heat) : base.b);
        const a = base.a;
        ctx.beginPath();
        ctx.arc(p.x+0.5, p.y+0.5, size, 0, Math.PI*2);
        ctx.fillStyle = rgbStr({r,g,b,a});
        ctx.fill();
      }
      requestAnimationFrame(drawFrame);
    }

    /************ INPUT ************/
    function toCanvasPos(evt){
      const r = canvas.getBoundingClientRect();
      const clientX = (evt.clientX ?? evt.touches?.[0]?.clientX);
      const clientY = (evt.clientY ?? evt.touches?.[0]?.clientY);
      const x = (clientX - r.left) * (canvas.width / r.width);
      const y = (clientY - r.top)  * (canvas.height / r.height);
      return { x: clamp(x,0,canvas.width-1), y: clamp(y,0,canvas.height-1) };
    }
    function sendHover(x,y){
      applyBrush(x,y,COLOR,RADIUS);
      if (RT.enabled) {
        RT.db.ref('rooms/'+ROOM+'/events').push({
          type:'hover', payload:{x,y,r:RADIUS,c: COLOR}, client: CLIENT, ts: Date.now()
        });
      }
    }
    const menuEl = $('#menu');
    menuEl.querySelector('button.kebab').addEventListener('click', ()=>{
      menuEl.classList.toggle('open');
      menuEl.querySelector('button.kebab').setAttribute('aria-expanded', menuEl.classList.contains('open'));
    });
    document.addEventListener('click', (e)=>{ if (!menuEl.contains(e.target)) menuEl.classList.remove('open'); });

    $('#color').addEventListener('input', e=> COLOR = e.target.value);
    $('#spacing').addEventListener('input', e=>{ SPACING = parseInt(e.target.value,10); buildZone(); });
    $('#radius').addEventListener('input', e=> RADIUS = parseInt(e.target.value,10));
    $('#life').addEventListener('input', e=> LIFE_MS = parseInt(e.target.value,10));

    const copyBtn = $('#copyRoom'), rtFlag = $('#rtFlag');
    copyBtn.addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(location.href);
      const t = copyBtn.textContent;
      copyBtn.textContent = 'Copiato!'; setTimeout(()=>copyBtn.textContent=t, 900);
    });

    canvas.addEventListener('pointermove', (e)=>{ const p = toCanvasPos(e); sendHover(p.x, p.y); });
    canvas.addEventListener('touchmove', (e)=>{ const p = toCanvasPos(e); sendHover(p.x, p.y); }, {passive:true});
    window.addEventListener('resize', resizeCanvas);

    /************ REALTIME ************/
    function setRt(on,msg){
      RT.enabled = !!on;
      rtFlag.textContent = on? 'ON':'OFF';
      rtFlag.className = on? 'ok' : 'warn';
      if (msg) console.log('Realtime:', msg);
    }
    function initRealtime(){
      try{
        const dbi  = firebase.database();
        RT.db = dbi;
        dbi.ref('rooms/'+ROOM+'/events').on('child_added', snap=>{
          const ev = snap.val(); if (!ev) return;
          if (ev.client === CLIENT) return;
          if (ev.type === 'hover'){
            const p = ev.payload; applyBrush(p.x, p.y, p.c, p.r);
          }
        });
        setRt(true, 'stanza #'+ROOM);
      }catch(e){ console.error(e); setRt(false, 'errore init'); }
    }

    /************ BOOT ************/
    resizeCanvas();
    requestAnimationFrame(drawFrame);
    initRealtime();
  </script>
</body>
</html>
