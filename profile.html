<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profilo — Interlinked</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {
      background:#0B0F19;
      color:#e4e4e7;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding:14px;
    }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 16px;
      border:1px solid #2c344a;
      border-radius:16px;
      background:#141A2A;
      margin-bottom:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    .title { font-weight:800; font-size:1.2rem; }

    .iconbtn {
      display:grid; place-items:center;
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid #2c344a;
      background:#141a2a;
      cursor:pointer;
      color:#e4e4e7; font-size:20px;
      transition:0.2s;
    }
    .iconbtn:hover { background:#1b2235; color:#3b82f6; }

    .content {
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .avatar {
      width:100px;height:100px;
      border-radius:50%;
      background:linear-gradient(145deg,#2c344a,#141A2A);
      display:grid;place-items:center;
      font-size:42px;
      align-self:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
      color:#3b82f6;
    }

    .field {display:flex;flex-direction:column;gap:8px;}
    .label {font-size:14px;color:#9ca3af;}
    .input, .readonly {
      padding:12px;
      border-radius:12px;
      border:1px solid #2c344a;
      background:#141A2A;
      color:#e4e4e7;
      font-size:15px;
      width:100%;
      transition:0.2s;
    }
    .input:focus {outline:none;border-color:#3b82f6;}
    .readonly {opacity:.85}

    .btn-row {display:flex;gap:12px;flex-wrap:wrap}
    .btn {
      flex:1;
      padding:12px;
      border-radius:12px;
      border:1px solid #1f1f27;
      background:#141A2A;
      color:#e4e4e7;
      cursor:pointer;
      text-align:center;
      font-size:14px;
      font-weight:500;
      transition:0.2s;
      display:flex;align-items:center;justify-content:center;gap:6px;
    }
    .btn:hover {background:#1b2235; color:#3b82f6}
    .danger {
      background:#7f1d1d;
      border-color:#991b1b;
      width:100%;
      font-weight:600;
    }
    .danger:hover {background:#991b1b;color:#fff}

    /* Modal password */
    .modal-bg {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      justify-content:center;
      align-items:center;
      z-index:100;
    }
    .modal {
      background:#1a1a23;
      padding:24px;
      border-radius:16px;
      width:90%;
      max-width:400px;
      display:flex;
      flex-direction:column;
      gap:14px;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
    }
    .modal input {
      padding:12px;
      border-radius:12px;
      border:1px solid #1f1f27;
      background:#0f0f17;
      color:#e4e4e7;
      font-size:14px;
      width:100%;
    }
    .modal button {
      padding:12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:#3b82f6;
      color:#fff;
      font-weight:600;
      transition:0.2s;
    }
    .modal button:hover { background:#2563eb; }
    .modal-cancel {background:#1a1a23 !important;color:#e4e4e7;font-weight:500}
    .modal-cancel:hover {background:#23232f !important}
  </style>
  <!-- Icone -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body>
  <div class="topbar">
    <button class="iconbtn" onclick="location.href='index.html'"><i data-lucide="arrow-left"></i></button>
    <div class="title">Profilo</div>
    <div style="width:40px"></div>
  </div>

  <div class="content">
    <div class="avatar"><i data-lucide="user"></i></div>

    <div class="field">
      <div class="label">Nome utente</div>
      <input id="username" class="input" type="text" placeholder="Inserisci nome" />
    </div>

    <div class="field">
      <div class="label">Email</div>
      <div id="email" class="readonly"></div>
    </div>

    <div class="field">
      <div class="label">Telefono</div>
      <input id="phone" class="input" type="tel" placeholder="Es. +393331234567" />
    </div>

    <div class="btn-row">
      <button id="changePassBtn" class="btn"><i data-lucide="lock"></i>Cambia Password</button>
      <button id="saveBtn" class="btn"><i data-lucide="save"></i>Salva</button>
    </div>
    <button id="deleteBtn" class="btn danger"><i data-lucide="trash-2"></i>Elimina Account</button>
  </div>

  <!-- Modal Cambio Password -->
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <div>Inserisci la nuova password:</div>
      <input type="password" id="newPassword" placeholder="Nuova password">
      <button id="modalConfirm">Conferma</button>
      <button id="modalCancel" class="modal-cancel">Annulla</button>
    </div>
  </div>

  <!-- Themed Modal / Toast -->
  <div id="uiModalBg" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:100">
    <div style="background:#1a1a23;border:1px solid #2c344a;border-radius:14px;padding:16px;max-width:420px;width:90%;display:flex;flex-direction:column;gap:12px;box-shadow:0 18px 42px rgba(0,0,0,.55)">
      <div id="uiTitle" style="font-weight:700">Titolo</div>
      <div id="uiMessage" style="opacity:.8"></div>
      <input id="uiInput" style="display:none;padding:10px;border-radius:10px;border:1px solid #2c344a;background:#0f0f17;color:#e4e4e7" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="uiCancel" class="btn">Annulla</button>
        <button id="uiOk" class="btn" style="background:#3b82f6;border-color:#3b82f6;color:#fff">OK</button>
      </div>
    </div>
  </div>
  <div id="uiToast" style="position:fixed;right:14px;bottom:14px;background:#111827;color:#e4e4e7;border:1px solid #374151;border-radius:12px;padding:10px 12px;z-index:120;display:none"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyAd2Uv9xA36L49YPezEO1QpC6P7t9zHXto",
      authDomain: "interlinked-demo.firebaseapp.com",
      databaseURL: "https://interlinked-demo-default-rtdb.firebaseio.com",
      projectId: "interlinked-demo",
      storageBucket: "interlinked-demo.firebasestorage.app",
      messagingSenderId: "85117709871",
      appId: "1:85117709871:web:a154569112f845e2bfe0da",
      measurementId: "G-RBLX6ZQD01"
    });

    const auth = firebase.auth(), db = firebase.database();
    const username = document.getElementById("username"), email = document.getElementById("email"), phone = document.getElementById("phone");

    const modalBg = document.getElementById("modalBg");
    const newPassword = document.getElementById("newPassword");
    const modalConfirm = document.getElementById("modalConfirm");
    const modalCancel = document.getElementById("modalCancel");

    auth.onAuthStateChanged(user => {
      if (!user) { location.replace("login.html"); return; }

      email.textContent = user.email || "";

      db.ref("users/"+user.uid+"/profile").on("value", snap => {
        const profile = snap.val() || {};
        username.value = profile.name || "";
        phone.value = profile.phone || "";
      });

      document.getElementById("saveBtn").onclick = async () => {
        const val = username.value.trim() || "Utente";
        const phoneRaw = phone.value.trim();
        const norm = normalizePhone(phoneRaw);
        try {
          // controllo univocità solo se valorizzato
          if (norm) {
            const m = await db.ref('byPhone/'+norm).once('value');
            const existingUid = m.val();
            if (existingUid && existingUid !== user.uid) {
              alert('Numero già in uso da un altro account.');
              return;
            }
          }

          // leggi phone precedente per pulire indice se necessario
          const prevSnap = await db.ref('users/'+user.uid+'/profile/phone').once('value');
          const prev = prevSnap.val();

          await db.ref("users/" + user.uid + "/profile").update({ name: val, phone: norm || null });

          const updates = {};
          // set nuovo indice
          if (norm) updates['byPhone/'+norm] = user.uid;
          // rimuovi vecchio indice se cambiato
          if (prev && prev !== norm) updates['byPhone/'+prev] = null;
          await db.ref().update(updates);
          showToast("Profilo salvato!");
        } catch(err){ alert('Errore salvataggio: '+ err.message); }
      };

      // Cambio password
      document.getElementById("changePassBtn").onclick = () => {
        modalBg.style.display = "flex";
        newPassword.value = "";
      };

      modalCancel.onclick = () => {
        modalBg.style.display = "none";
      };

      modalConfirm.onclick = async () => {
        const pwd = newPassword.value;
        if (!pwd) return alert("Inserisci la nuova password!");

        try {
          await user.updatePassword(pwd);
          alert("Password aggiornata con successo!");
          modalBg.style.display = "none";
        } catch (err) {
          alert("Errore: " + err.message);
        }
      };

      // Eliminazione account
      document.getElementById("deleteBtn").onclick = async () => {
        const ok = await appConfirm({ title:'Elimina', message:'Sei sicuro di voler eliminare l\'account?' });
        if(ok){
          // pulizia indici email/phone
          try {
            const ps = await db.ref('users/'+user.uid+'/profile').once('value');
            const p = ps.val() || {};
            const updates = {};
            if (p.email) updates['byEmail/'+String(p.email).toLowerCase()] = null;
            if (p.phone) updates['byPhone/'+p.phone] = null;
            await db.ref().update(updates);
          } catch(_){}
          await db.ref("users/" + user.uid).remove();
          await user.delete();
          showToast("Account eliminato!");
          location.replace("signup.html");
        }
      };
    });

    lucide.createIcons();

    // Themed dialog helpers
    function appDialog({title,message,showInput,value,okText='OK',cancelText='Annulla'}){
      return new Promise(res=>{
        const bg = document.getElementById('uiModalBg');
        const ti = document.getElementById('uiTitle');
        const msg = document.getElementById('uiMessage');
        const inp = document.getElementById('uiInput');
        const ok = document.getElementById('uiOk');
        const cc = document.getElementById('uiCancel');
        ti.textContent = title||''; msg.textContent = message||'';
        inp.style.display = showInput? 'block':'none'; inp.value = value||'';
        ok.textContent = okText; cc.textContent = cancelText;
        function close(v){ bg.style.display='none'; ok.onclick=null; cc.onclick=null; res(v); }
        ok.onclick=()=> close(showInput? inp.value : true);
        cc.onclick=()=> close(showInput? null : false);
        bg.style.display='flex'; if (showInput) inp.focus();
      });
    }
    function appConfirm(opts){ return appDialog({ ...opts, showInput:false }); }
    function showToast(msg){ const t=document.getElementById('uiToast'); t.textContent=msg; t.style.display='block'; clearTimeout(t.__to); t.__to=setTimeout(()=>{ t.style.display='none'; }, 2200); }

    function normalizePhone(input){
      if (!input) return "";
      const trimmed = String(input).replace(/\s+/g, "");
      const m = trimmed.match(/^\+?[0-9]{6,}$/);
      if (!m) return "";
      if (trimmed.startsWith('+')) return trimmed;
      return trimmed;
    }
  </script>
</body>
</html>
