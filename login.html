<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interlinked — Login</title>
  <style>
    :root { --gap:12px; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      min-height:100vh; background:#0f172a; color:#e5e7eb;
      display:grid; place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding:16px;
    }
    .card {
      width:100%; max-width:420px;
      background:#0b1220; border:1px solid #334155; border-radius:16px;
      padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; gap:14px;
    }
    .title { font-weight:900; font-size:1.6rem; text-align:center; margin-bottom:6px; color:#3b82f6; }
    .field { display:flex; flex-direction:column; gap:6px; position:relative; }
    label { font-size:.9rem; color:#cbd5e1; }
    input {
      width:100%; padding:12px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; height:44px;
    }
    /* Evita che il testo si sovrapponga all’icona quando il tipo cambia */
    .with-eye { padding-right:44px; }

    /* Bottone icona accessibile e non deformabile */
    .icon-btn {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:40px; height:40px; display:grid; place-items:center;
      background:transparent; border:0; border-radius:8px; cursor:pointer; color:#94a3b8;
    }
    .icon-btn:hover { color:#cbd5e1; background:#0f1b33; }
    .icon-btn:active { transform:translateY(-50%) scale(0.98); }
    .icon-btn svg { width:22px; height:22px; aspect-ratio:1 / 1; display:block; }
    .btn {
      width:100%; padding:12px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer;
      font-weight:700;
    }
    .btn:hover { background:#10192c; }
    .google { display:flex; align-items:center; justify-content:center; gap:10px; font-weight:700; }
    .muted { text-align:center; font-size:.9rem; color:#94a3b8; }
    .link { color:#93c5fd; cursor:pointer; }
    .error { color:#fca5a5; font-size:.9rem; min-height:1.2em; text-align:center; }
    .success { color:#4ade80; font-size:.9rem; min-height:1.2em; text-align:center; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Interlinked</div>

    <div class="field">
      <label for="identifier">E-mail o Telefono</label>
      <input id="identifier" type="text" placeholder="es. mario@esempio.com o +39333..." autocomplete="email tel" />
    </div>

    <div class="field">
      <label for="password">Password</label>
      <input id="password" class="with-eye" type="password" autocomplete="current-password" />
      <button id="toggleEye" class="icon-btn" type="button" aria-label="Mostra password" aria-pressed="false" title="Mostra password">
        <!-- Icona occhio (stroke, rapporto 1:1) con slash che appare/scompare -->
        <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <!-- Occhio -->
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
          <!-- Slash (inizialmente nascosto) -->
          <line id="eyeSlash" x1="3" y1="3" x2="21" y2="21" style="display:none"></line>
        </svg>
      </button>
    </div>

    <button id="emailLogin" class="btn">Entra</button>
    <div class="muted">oppure</div>
    <button id="googleLogin" class="btn google">↪︎ Continua con Google</button>

    <div class="muted">Non hai un account? <a href="signup.html" class="link">Registrati</a></div>
    <div class="muted"><span id="resetPassword" class="link">Cambia password</span></div>

    <div id="error" class="error"></div>
    <div id="success" class="success"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    // Configurazione Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyAd2Uv9xA36L49YPezEO1QpC6P7t9zHXto",
      authDomain: "interlinked-demo.firebaseapp.com",
      databaseURL: "https://interlinked-demo-default-rtdb.firebaseio.com",
      projectId: "interlinked-demo",
      storageBucket: "interlinked-demo.firebasestorage.app",
      messagingSenderId: "85117709871",
      appId: "1:85117709871:web:a154569112f845e2bfe0da",
      measurementId: "G-RBLX6ZQD01"
    });

    const auth = firebase.auth();
    auth.onAuthStateChanged(u => { if (u) location.replace('index.html'); });

    // Helpers
    const $ = s => document.querySelector(s);
    const showErr = (m)=> { $("#error").textContent = m || ""; if(m) $("#success").textContent=""; };
    const showOk  = (m)=> { $("#success").textContent = m || ""; if(m) $("#error").textContent=""; };

    // Toggle password + accessibilità
    (function(){
      const btn = $("#toggleEye");
      const slash = $("#eyeSlash");
      const input = $("#password");
      const setVisible = (visible) => {
        input.type = visible ? "text" : "password";
        slash.style.display = visible ? "block" : "none";
        btn.setAttribute("aria-pressed", visible ? "true" : "false");
        btn.setAttribute("title", visible ? "Nascondi password" : "Mostra password");
      };
      const toggle = () => setVisible(input.type === "password");

      // Click toggles
      btn.addEventListener("click", toggle);
      btn.addEventListener("keydown", (e)=> {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
      });

      // Hold-to-peek while pressed
      const pressStart = () => setVisible(true);
      const pressEnd = () => setVisible(false);
      btn.addEventListener("mousedown", pressStart);
      btn.addEventListener("mouseup", pressEnd);
      btn.addEventListener("mouseleave", pressEnd);
      btn.addEventListener("touchstart", pressStart, { passive:true });
      btn.addEventListener("touchend", pressEnd);
      btn.addEventListener("touchcancel", pressEnd);
    })();

    // Login con email O telefono e password
    $("#emailLogin").addEventListener("click", async ()=>{
      showErr(""); showOk("");
      const identifier = $("#identifier").value.trim();
      const pass  = $("#password").value;
      if(!identifier || !pass) return showErr("Inserisci e-mail/telefono e password.");
      try {
        const { email } = await resolveIdentifierToEmail(identifier);
        if (!email) throw new Error("auth/user-not-found");
        await auth.signInWithEmailAndPassword(email, pass);
        location.replace('index.html');
      } catch(e) {
        showErr(mapErr(e));
      }
    });

    // Login con Google
    $("#googleLogin").addEventListener("click", async ()=>{
      showErr(""); showOk("");
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        // Assicura profilo e indici
        try {
          const uid = user.uid;
          const email = (user.email || '').toLowerCase();
          const name = user.displayName || 'Utente';
          const profRef = firebase.database().ref('users/'+uid+'/profile');
          const snap = await profRef.once('value');
          const existing = snap.val() || {};
          await profRef.update({ email: email || existing.email || null, name: existing.name || name });
          const updates = {};
          if (email) updates['byEmail/'+email] = uid;
          await firebase.database().ref().update(updates);
        } catch(_e) { /* ignore */ }
        location.replace('index.html');
      } catch(e) {
        showErr(mapErr(e));
      }
    });

    // Reset password
    $("#resetPassword").addEventListener("click", async ()=>{
      showErr(""); showOk("");
      const email = $("#email").value.trim();
      if(!email) return showErr("Inserisci prima la tua e-mail.");
      try {
        await auth.sendPasswordResetEmail(email);
        showOk("E-mail di ripristino inviata!");
      } catch(e) {
        showErr(mapErr(e));
      }
    });

    // Mappatura errori
    function mapErr(e){
      const c = e?.code || "";
      if (c.includes("auth/invalid-email")) return "E-mail non valida.";
      if (c.includes("auth/user-not-found")) return "Utente inesistente.";
      if (c.includes("auth/wrong-password")) return "Password errata.";
      if (c.includes("auth/popup-closed-by-user")) return "Accesso annullato.";
      return "Errore: " + (e?.message || e);
      //return "Errore, riprova!";
    }

    // Risolve un identificativo generico (email o telefono) in un'email per Firebase Auth
    async function resolveIdentifierToEmail(identifier){
      const normPhone = normalizePhone(identifier.trim());
      if (isValidEmail(identifier)) {
        return { email: identifier.toLowerCase() };
      }
      if (normPhone) {
        try {
          // prefer fast index
          const idx = await firebase.database().ref('byPhone/'+normPhone).once('value');
          let uid = idx.val();
          if (!uid) {
            // fallback scan: find profile.phone === normPhone
            const all = await firebase.database().ref('users').once('value');
            const users = all.val() || {};
            for (const k in users){
              const p = users[k]?.profile || {};
              if ((p.phone || '') === normPhone) { uid = k; break; }
            }
          }
          if (!uid) return { email: null };
          const prof = await firebase.database().ref('users/'+uid+'/profile/email').once('value');
          const email = prof.val() || null;
          return { email: email ? String(email).toLowerCase() : null };
        } catch(_){ return { email: null }; }
      }
      // ultimo tentativo: mappa byEmail
      try {
        const snap = await firebase.database().ref('byEmail/'+identifier.toLowerCase()).once('value');
        const uid = snap.val();
        if (!uid) return { email: null };
        const prof = await firebase.database().ref('users/'+uid+'/profile/email').once('value');
        return { email: prof.val() ? String(prof.val()).toLowerCase() : null };
      } catch(_){ return { email: null }; }
    }

    function isValidEmail(s){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function normalizePhone(input){
      if (!input) return "";
      const trimmed = input.replace(/\s+/g, "");
      const m = trimmed.match(/^\+?[0-9]{6,}$/);
      if (!m) return "";
      if (trimmed.startsWith('+')) return trimmed;
      return trimmed;
    }
  </script>
</body>
</html>
